SUBROUTINE invmtx(a,b,deter,nsize)
!***********************************************************************
!
!***this routine inverts a square matrix "a"
!
!     a  -  given nsize*nsize matrix
!     b  -  inverse of "a"
!     nsize  -  matrix size
!
!***********************************************************************
IMPLICIT NONE
INTEGER (kind=4),INTENT(IN) :: nsize
REAL (kind=8),INTENT(IN) :: a(nsize,nsize)
REAL (kind=8),INTENT(OUT):: b(nsize,nsize),deter

REAL (kind=8) :: denom,t1,t2,t3,t4

SELECT CASE (nsize)
CASE (1)
  !***inverse of a 1*1 matrix
  deter=a(1,1)
  IF(deter == 0d0) RETURN
  b(1,1) = 1d0/a(1,1)

CASE (2)
  !***inverse of a 2*2 matrix
  deter = a(1,1)*a(2,2)-a(2,1)*a(1,2)
  IF(deter == 0d0) RETURN
  b(1,1) = a(2,2)/deter
  b(2,2) = a(1,1)/deter
  b(2,1) =-a(2,1)/deter
  b(1,2) =-a(1,2)/deter

CASE (3)
  !*** inverse of a 3*3 matrix
  t1  = a(2,2)*a(3,3) - a(3,2)*a(2,3)
  t2  =-a(2,1)*a(3,3) + a(3,1)*a(2,3)
  t3  = a(2,1)*a(3,2) - a(3,1)*a(2,2)
  deter = a(1,1)*t1 + a(1,2)*t2 + a(1,3)*t3
  IF(deter == 0d0) RETURN
  b(1,1) = t1/deter
  b(2,1) = t2/deter
  b(3,1) = t3/deter
  b(2,2) = ( a(1,1)*a(3,3) - a(3,1)*a(1,3))/deter
  b(3,2) = (-a(1,1)*a(3,2) + a(1,2)*a(3,1))/deter
  b(3,3) = ( a(1,1)*a(2,2) - a(2,1)*a(1,2))/deter
  b(1,2) = (-a(1,2)*a(3,3) + a(3,2)*a(1,3))/deter
  b(1,3) = ( a(1,2)*a(2,3) - a(2,2)*a(1,3))/deter
  b(2,3) = (-a(1,1)*a(2,3) + a(2,1)*a(1,3))/deter

CASE (4)
  !*** inverse of a 4*4 matrix
  t1= a(2,2)*a(3,3)*a(4,4) + a(2,3)*a(3,4)*a(4,2) +               &
      a(2,4)*a(3,2)*a(4,3) - a(2,3)*a(3,2)*a(4,4) -               &
      a(2,2)*a(3,4)*a(4,3) - a(2,4)*a(3,3)*a(4,2)
  t2=-a(2,1)*a(3,3)*a(4,4) - a(2,3)*a(3,4)*a(4,1) -               &
      a(2,4)*a(3,1)*a(4,3) + a(2,4)*a(3,3)*a(4,1) +               &
      a(2,3)*a(3,1)*a(4,4) + a(2,1)*a(3,4)*a(4,3)
  t3=+a(2,1)*a(3,2)*a(4,4) + a(2,2)*a(3,4)*a(4,1) +               &
      a(2,4)*a(3,1)*a(4,2) - a(2,4)*a(3,2)*a(4,1) -               &
      a(2,2)*a(3,1)*a(4,4) - a(2,1)*a(3,4)*a(4,2)
  t4=-a(2,1)*a(3,2)*a(4,3) - a(2,2)*a(3,3)*a(4,1) -               &
      a(2,3)*a(3,1)*a(4,2) + a(2,3)*a(3,2)*a(4,1) +               &
      a(2,2)*a(3,1)*a(4,3) + a(2,1)*a(3,3)*a(4,2)
  deter= a(1,1)*t1 + a(1,2)*t2 + a(1,3)*t3 + a(1,4)*t4
  IF(deter == 0d0) RETURN
  denom = 1.d0/deter
  b(1,1) = t1*denom
  b(2,1) = t2*denom
  b(3,1) = t3*denom
  b(4,1) = t4*denom
  b(1,2) =(- a(1,2)*a(3,3)*a(4,4) - a(1,3)*a(3,4)*a(4,2)          &
         - a(1,4)*a(3,2)*a(4,3) + a(1,3)*a(3,2)*a(4,4)            &
         + a(1,2)*a(3,4)*a(4,3) + a(1,4)*a(3,3)*a(4,2))*denom
  b(2,2) =(  a(1,1)*a(3,3)*a(4,4) + a(1,3)*a(3,4)*a(4,1)          &
           + a(1,4)*a(3,1)*a(4,3) - a(1,4)*a(3,3)*a(4,1)          &
           - a(1,3)*a(3,1)*a(4,4) - a(1,1)*a(3,4)*a(4,3))*denom
  b(3,2) =(- a(1,1)*a(3,2)*a(4,4) - a(1,2)*a(3,4)*a(4,1)          &
           - a(1,4)*a(3,1)*a(4,2) + a(1,4)*a(3,2)*a(4,1)          &
           + a(1,2)*a(3,1)*a(4,4) + a(1,1)*a(3,4)*a(4,2))*denom
  b(4,2) =(  a(1,1)*a(3,2)*a(4,3) + a(1,2)*a(3,3)*a(4,1)          &
           + a(1,3)*a(3,1)*a(4,2) - a(1,3)*a(3,2)*a(4,1)          &
           - a(1,2)*a(3,1)*a(4,3) - a(1,1)*a(3,3)*a(4,2))*denom
  b(1,3) =(  a(1,2)*a(2,3)*a(4,4) + a(1,3)*a(2,4)*a(4,2)          &
           + a(1,4)*a(2,2)*a(4,3) - a(1,3)*a(2,2)*a(4,4)          &
           - a(1,2)*a(2,4)*a(4,3) - a(1,4)*a(2,3)*a(4,2))*denom
  b(2,3) =(- a(1,1)*a(2,3)*a(4,4) - a(1,3)*a(2,4)*a(4,1)          &
           - a(1,4)*a(2,1)*a(4,3) + a(1,4)*a(2,3)*a(4,1)          &
           + a(1,3)*a(2,1)*a(4,4) + a(1,1)*a(2,4)*a(4,3))*denom
  b(3,3) =(  a(1,1)*a(2,2)*a(4,4) + a(1,2)*a(2,4)*a(4,1)          &
           + a(1,4)*a(2,1)*a(4,2) - a(1,4)*a(2,2)*a(4,1)          &
           - a(1,2)*a(2,1)*a(4,4) - a(1,1)*a(2,4)*a(4,2))*denom
  b(4,3) =(- a(1,1)*a(2,2)*a(4,3) - a(1,2)*a(2,3)*a(4,1)          &
           - a(1,3)*a(2,1)*a(4,2) + a(1,3)*a(2,2)*a(4,1)          &
           + a(1,2)*a(2,1)*a(4,3) + a(1,1)*a(2,3)*a(4,2))*denom
  b(1,4) =(- a(1,2)*a(2,3)*a(3,4) - a(1,3)*a(2,4)*a(3,2)          &
           - a(1,4)*a(2,2)*a(3,3) + a(1,4)*a(2,3)*a(3,2)          &
           + a(1,3)*a(2,2)*a(3,4) + a(1,2)*a(2,4)*a(3,3))*denom
  b(2,4) =(  a(1,1)*a(2,3)*a(3,4) + a(1,3)*a(2,4)*a(3,1)          &
           + a(1,4)*a(2,1)*a(3,3) - a(1,4)*a(2,3)*a(3,1)          &
           - a(1,3)*a(2,1)*a(3,4) - a(1,1)*a(2,4)*a(3,3))*denom
  b(3,4) =(- a(1,1)*a(2,2)*a(3,4) - a(1,2)*a(2,4)*a(3,1)          &
           - a(1,4)*a(2,1)*a(3,2) + a(1,4)*a(2,2)*a(3,1)          &
           + a(1,2)*a(2,1)*a(3,4) + a(1,1)*a(2,4)*a(3,2))*denom
  b(4,4) =(  a(1,1)*a(2,2)*a(3,3) + a(1,2)*a(2,3)*a(3,1)          &
           + a(1,3)*a(2,1)*a(3,2) - a(1,3)*a(2,2)*a(3,1)          &
           - a(1,2)*a(2,1)*a(3,3) - a(1,1)*a(2,3)*a(3,2))*denom
END SELECT
RETURN

END SUBROUTINE invmtx
