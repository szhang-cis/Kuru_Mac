      SUBROUTINE INVMTX(A,B,DETER,NSIZE)
C***********************************************************************
C
C**** THIS ROUTINE INVERTS A SQUARE MATRIX "A"
C
C     A  -  GIVEN NSIZE*NSIZE MATRIX
C     B  -  INVERSE OF "A"
C     NSIZE  -  MATRIX SIZE 
C
C***********************************************************************
      IMPLICIT REAL*8(A-H,O-Z)
      DIMENSION A(NSIZE,*), B(NSIZE,*)
C
C***INVERS OF A 1*1 MATRIX
C
      IF(NSIZE.EQ.1) THEN
        DETER=A(1,1)
        IF(DETER.EQ.0.) RETURN
        B(1,1) = 1./A(1,1)
        RETURN
      ENDIF
C
C***INVERS OF A 2*2 MATRIX
C
      IF(NSIZE.EQ.2) THEN
        DETER=A(1,1)*A(2,2)-A(2,1)*A(1,2)
        IF(DETER.EQ.0.) RETURN
        DENOM=1./DETER
        B(1,1) = A(2,2)*DENOM
        B(2,2) = A(1,1)*DENOM
        B(2,1) =-A(2,1)*DENOM
        B(1,2) =-A(1,2)*DENOM
        RETURN
      ENDIF
C
C*** INVERSE OF A 3*3 MATRIX
C
      IF(NSIZE.EQ.3) THEN
        T1  = A(2,2)*A(3,3) - A(3,2)*A(2,3)
        T2  =-A(2,1)*A(3,3) + A(3,1)*A(2,3)
        T3  = A(2,1)*A(3,2) - A(3,1)*A(2,2)
        DETER = A(1,1)*T1 + A(1,2)*T2 + A(1,3)*T3
        IF(DETER.EQ.0.0) RETURN
        DENOM = 1./DETER
        B(1,1) = T1*DENOM
        B(2,1) = T2*DENOM
        B(3,1) = T3*DENOM
        B(2,2) = ( A(1,1)*A(3,3) - A(3,1)*A(1,3))*DENOM
        B(3,2) = (-A(1,1)*A(3,2) + A(1,2)*A(3,1))*DENOM
        B(3,3) = ( A(1,1)*A(2,2) - A(2,1)*A(1,2))*DENOM
        B(1,2) = (-A(1,2)*A(3,3) + A(3,2)*A(1,3))*DENOM
        B(1,3) = ( A(1,2)*A(2,3) - A(2,2)*A(1,3))*DENOM
        B(2,3) = (-A(1,1)*A(2,3) + A(2,1)*A(1,3))*DENOM
        RETURN
      ENDIF
C
C*** INVERSE OF A 4*4 MATRIX
C
      IF(NSIZE.EQ.4) THEN
        T1= A(2,2)*A(3,3)*A(4,4) + A(2,3)*A(3,4)*A(4,2) +
     .      A(2,4)*A(3,2)*A(4,3)
     .     -A(2,3)*A(3,2)*A(4,4) - A(2,2)*A(3,4)*A(4,3) -
     .      A(2,4)*A(3,3)*A(4,2)
        T2=-A(2,1)*A(3,3)*A(4,4) - A(2,3)*A(3,4)*A(4,1) -
     .      A(2,4)*A(3,1)*A(4,3)
     .     +A(2,4)*A(3,3)*A(4,1) + A(2,3)*A(3,1)*A(4,4) +
     .      A(2,1)*A(3,4)*A(4,3)
        T3=+A(2,1)*A(3,2)*A(4,4) + A(2,2)*A(3,4)*A(4,1) +
     .      A(2,4)*A(3,1)*A(4,2)
     .     -A(2,4)*A(3,2)*A(4,1) - A(2,2)*A(3,1)*A(4,4) -
     .      A(2,1)*A(3,4)*A(4,2)
        T4=-A(2,1)*A(3,2)*A(4,3) - A(2,2)*A(3,3)*A(4,1) -
     .      A(2,3)*A(3,1)*A(4,2)
     .     +A(2,3)*A(3,2)*A(4,1) + A(2,2)*A(3,1)*A(4,3) +
     .      A(2,1)*A(3,3)*A(4,2)
        DETER= A(1,1)*T1 + A(1,2)*T2 + A(1,3)*T3 + A(1,4)*T4
        IF(DETER.EQ.0.) RETURN
        DENOM=1./DETER
        B(1,1) = T1*DENOM
        B(2,1) = T2*DENOM
        B(3,1) = T3*DENOM
        B(4,1) = T4*DENOM
        B(1,2) =(- A(1,2)*A(3,3)*A(4,4) - A(1,3)*A(3,4)*A(4,2)
     .           - A(1,4)*A(3,2)*A(4,3) + A(1,3)*A(3,2)*A(4,4)
     .           + A(1,2)*A(3,4)*A(4,3) + A(1,4)*A(3,3)*A(4,2))*DENOM
        B(2,2) =(  A(1,1)*A(3,3)*A(4,4) + A(1,3)*A(3,4)*A(4,1)
     .           + A(1,4)*A(3,1)*A(4,3) - A(1,4)*A(3,3)*A(4,1)
     .           - A(1,3)*A(3,1)*A(4,4) - A(1,1)*A(3,4)*A(4,3))*DENOM
        B(3,2) =(- A(1,1)*A(3,2)*A(4,4) - A(1,2)*A(3,4)*A(4,1)
     .           - A(1,4)*A(3,1)*A(4,2) + A(1,4)*A(3,2)*A(4,1)
     .           + A(1,2)*A(3,1)*A(4,4) + A(1,1)*A(3,4)*A(4,2))*DENOM
        B(4,2) =(  A(1,1)*A(3,2)*A(4,3) + A(1,2)*A(3,3)*A(4,1)
     .           + A(1,3)*A(3,1)*A(4,2) - A(1,3)*A(3,2)*A(4,1)
     .           - A(1,2)*A(3,1)*A(4,3) - A(1,1)*A(3,3)*A(4,2))*DENOM
        B(1,3) =(  A(1,2)*A(2,3)*A(4,4) + A(1,3)*A(2,4)*A(4,2)
     .           + A(1,4)*A(2,2)*A(4,3) - A(1,3)*A(2,2)*A(4,4)
     .           - A(1,2)*A(2,4)*A(4,3) - A(1,4)*A(2,3)*A(4,2))*DENOM
        B(2,3) =(- A(1,1)*A(2,3)*A(4,4) - A(1,3)*A(2,4)*A(4,1)
     .           - A(1,4)*A(2,1)*A(4,3) + A(1,4)*A(2,3)*A(4,1)
     .           + A(1,3)*A(2,1)*A(4,4) + A(1,1)*A(2,4)*A(4,3))*DENOM
        B(3,3) =(  A(1,1)*A(2,2)*A(4,4) + A(1,2)*A(2,4)*A(4,1)
     .           + A(1,4)*A(2,1)*A(4,2) - A(1,4)*A(2,2)*A(4,1)
     .           - A(1,2)*A(2,1)*A(4,4) - A(1,1)*A(2,4)*A(4,2))*DENOM
        B(4,3) =(- A(1,1)*A(2,2)*A(4,3) - A(1,2)*A(2,3)*A(4,1)
     .           - A(1,3)*A(2,1)*A(4,2) + A(1,3)*A(2,2)*A(4,1)
     .           + A(1,2)*A(2,1)*A(4,3) + A(1,1)*A(2,3)*A(4,2))*DENOM
        B(1,4) =(- A(1,2)*A(2,3)*A(3,4) - A(1,3)*A(2,4)*A(3,2)
     .           - A(1,4)*A(2,2)*A(3,3) + A(1,4)*A(2,3)*A(3,2)
     .           + A(1,3)*A(2,2)*A(3,4) + A(1,2)*A(2,4)*A(3,3))*DENOM
        B(2,4) =(  A(1,1)*A(2,3)*A(3,4) + A(1,3)*A(2,4)*A(3,1)
     .           + A(1,4)*A(2,1)*A(3,3) - A(1,4)*A(2,3)*A(3,1)
     .           - A(1,3)*A(2,1)*A(3,4) - A(1,1)*A(2,4)*A(3,3))*DENOM
        B(3,4) =(- A(1,1)*A(2,2)*A(3,4) - A(1,2)*A(2,4)*A(3,1)
     .           - A(1,4)*A(2,1)*A(3,2) + A(1,4)*A(2,2)*A(3,1)
     .           + A(1,2)*A(2,1)*A(3,4) + A(1,1)*A(2,4)*A(3,2))*DENOM
        B(4,4) =(  A(1,1)*A(2,2)*A(3,3) + A(1,2)*A(2,3)*A(3,1)
     .           + A(1,3)*A(2,1)*A(3,2) - A(1,3)*A(2,2)*A(3,1)
     .           - A(1,2)*A(2,1)*A(3,3) - A(1,1)*A(2,3)*A(3,2))*DENOM
        RETURN
      ENDIF
C
C*** INVERSE OF A NSIZE*NSIZE MATRIX
C
      DO ISIZE=1,NSIZE
        DO JSIZE=1,NSIZE
          B(ISIZE,JSIZE)=A(ISIZE,JSIZE)
        ENDDO
      ENDDO
      CALL INVERT(B,NSIZE,NSIZE)
C
      RETURN
      END
